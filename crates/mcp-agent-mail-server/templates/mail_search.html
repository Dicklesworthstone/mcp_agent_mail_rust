{% extends "base.html" %}

{% block title %}Search â€” {{ project.human_key }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex items-center gap-2 text-sm">
  <a href="/mail" class="text-slate-600 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
    Projects
  </a>
  <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
  <a href="/mail/{{ project.slug }}" class="text-slate-600 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
    {{ project.human_key }}
  </a>
  <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
  <span class="text-slate-900 dark:text-white font-medium">Search</span>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in" x-data='{ scope: {{ scope|tojson }}, order: {{ order|tojson }}, showHelp: false, showFilters: {% if agent or thread or ack != "any" or direction or from_date or to_date or importance|length > 0 %}true{% else %}false{% endif %} }'>
  <!-- Search Header -->
  <div class="bg-white dark:bg-slate-800 rounded-xl p-8 shadow-soft border border-slate-200 dark:border-slate-700">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center shadow-medium">
          <i data-lucide="search" class="w-8 h-8 text-white"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Search Messages</h1>
          <p class="text-slate-600 dark:text-slate-400">Find messages across the project</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button @click="showFilters = !showFilters"
                :class="showFilters ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300'"
                class="px-4 py-2 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors flex items-center gap-2">
          <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
          Filters
        </button>
        <button @click="showHelp = !showHelp"
                class="px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg transition-colors flex items-center gap-2">
          <i data-lucide="help-circle" class="w-4 h-4"></i>
          Query Help
        </button>
      </div>
    </div>

    <!-- Help Panel -->
    <div x-show="showHelp"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform -translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform -translate-y-2"
         class="bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg p-6 mb-6">
      <h3 class="text-lg font-semibold text-primary-900 dark:text-primary-100 mb-4">Query Syntax</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-primary-800 dark:text-primary-200">
        <div class="flex items-start gap-3">
          <i data-lucide="search" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
          <div>
            <div class="font-semibold">Field filters:</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">subject:authentication</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">body:"API key"</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <i data-lucide="layers" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
          <div>
            <div class="font-semibold">Boolean operators:</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">login AND security</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">error NOT timeout</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <i data-lucide="asterisk" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
          <div>
            <div class="font-semibold">Prefix wildcard:</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">deploy*</div>
            <div class="font-mono bg-white dark:bg-slate-800 px-2 py-1 rounded mt-1">"exact phrase"</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Form -->
    <form id="searchForm" method="get" class="space-y-4">
      <!-- Search Input -->
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <i data-lucide="search" class="w-5 h-5 text-slate-400"></i>
        </div>
        <input
          type="text"
          id="q"
          name="q"
          value="{{ q }}"
          placeholder='Try: subject:login body:"api key"'
          class="w-full pl-12 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-lg text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
          aria-label="Search messages"
          autofocus
        />
        <input type="hidden" name="scope" x-model="scope" />
        <input type="hidden" name="order" x-model="order" />
      </div>

      <!-- Quick Controls Row -->
      <div class="flex items-center gap-6 flex-wrap">
        <!-- Scope -->
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Search in:</span>
          <div class="flex items-center gap-1">
            <button type="button" @click="scope = ''"
              :class="scope === '' ? 'bg-primary-600 text-white ring-2 ring-primary-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">Both</button>
            <button type="button" @click="scope = 'subject'"
              :class="scope === 'subject' ? 'bg-primary-600 text-white ring-2 ring-primary-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">Subject</button>
            <button type="button" @click="scope = 'body'"
              :class="scope === 'body' ? 'bg-primary-600 text-white ring-2 ring-primary-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">Body</button>
          </div>
        </div>

        <!-- Order -->
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Order:</span>
          <div class="flex items-center gap-1">
            <button type="button" @click="order = 'relevance'"
              :class="order === 'relevance' ? 'bg-primary-600 text-white ring-2 ring-primary-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1">
              <i data-lucide="star" class="w-3.5 h-3.5"></i> Relevance</button>
            <button type="button" @click="order = 'time'"
              :class="order === 'time' ? 'bg-primary-600 text-white ring-2 ring-primary-500' : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'"
              class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-1">
              <i data-lucide="clock" class="w-3.5 h-3.5"></i> Time</button>
          </div>
        </div>

        <!-- Boost -->
        <div class="flex items-center gap-2">
          <input type="checkbox" id="boostSubject" name="boost" value="1" class="h-4 w-4 text-primary-600 border-slate-300 rounded" {% if boost %}checked{% endif %}>
          <label for="boostSubject" class="text-sm text-slate-700 dark:text-slate-300">Boost subject</label>
        </div>

        <button type="submit"
          class="ml-auto px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg shadow-medium hover:shadow-large transition-all duration-300 flex items-center gap-2 btn-ripple">
          <i data-lucide="search" class="w-5 h-5"></i>
          Search
        </button>
      </div>

      <!-- Advanced Filters Panel -->
      <div x-show="showFilters"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 transform -translate-y-2"
           x-transition:enter-end="opacity-100 transform translate-y-0"
           class="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-6">
        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
          <i data-lucide="filter" class="w-4 h-4"></i>
          Advanced Filters
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Importance -->
          <div>
            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Importance</label>
            <div class="flex flex-wrap gap-2">
              {% for level in ["low", "normal", "high", "urgent"] %}
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="checkbox" name="imp" value="{{ level }}"
                  {% if level in importance %}checked{% endif %}
                  class="h-3.5 w-3.5 text-primary-600 border-slate-300 rounded">
                <span class="text-sm {% if level == 'urgent' %}text-red-600 dark:text-red-400 font-medium{% elif level == 'high' %}text-orange-600 dark:text-orange-400{% else %}text-slate-700 dark:text-slate-300{% endif %}">{{ level|capitalize }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Agent -->
          <div>
            <label for="agentFilter" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Agent</label>
            <select id="agentFilter" name="agent" class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-900 dark:text-white" aria-label="Filter by agent">
              <option value="">All agents</option>
              {% for a in agents %}
              <option value="{{ a.name }}" {% if a.name == agent %}selected{% endif %}>{{ a.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Direction -->
          <div>
            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Direction</label>
            <div class="flex items-center gap-2">
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="direction" value="" {% if not direction %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Any</span>
              </label>
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="direction" value="inbox" {% if direction == "inbox" %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Inbox</span>
              </label>
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="direction" value="outbox" {% if direction == "outbox" %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Outbox</span>
              </label>
            </div>
          </div>

          <!-- Ack State -->
          <div>
            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Ack Required</label>
            <div class="flex items-center gap-2">
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="ack" value="any" {% if ack == "any" %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Any</span>
              </label>
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="ack" value="required" {% if ack == "required" %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Required</span>
              </label>
              <label class="inline-flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="ack" value="not_required" {% if ack == "not_required" %}checked{% endif %} class="text-primary-600">
                <span class="text-sm text-slate-700 dark:text-slate-300">Not required</span>
              </label>
            </div>
          </div>

          <!-- Thread -->
          <div>
            <label for="threadFilter" class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Thread ID</label>
            <input type="text" id="threadFilter" name="thread" value="{{ thread }}"
              placeholder="e.g. br-3vwi.4"
              class="w-full px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-900 dark:text-white placeholder-slate-500"
              aria-label="Filter by thread ID" />
          </div>

          <!-- Date Range -->
          <div>
            <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-2">Date Range</label>
            <div class="flex items-center gap-2">
              <input type="date" name="from_date" value="{{ from_date }}"
                class="flex-1 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-900 dark:text-white"
                aria-label="From date" />
              <span class="text-slate-400 text-sm">to</span>
              <input type="date" name="to_date" value="{{ to_date }}"
                class="flex-1 px-3 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sm text-slate-900 dark:text-white"
                aria-label="To date" />
            </div>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors">
            Apply Filters
          </button>
          <a href="/mail/{{ project.slug }}/search" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-sm font-medium rounded-lg transition-colors">
            Clear All
          </a>
        </div>
      </div>
    </form>
  </div>

  <div class="flex gap-6">
    <!-- Main Results Column -->
    <div class="flex-1 min-w-0">
      <!-- Search Results -->
      {% if results %}
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-soft border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i data-lucide="list" class="w-5 h-5 text-primary-600 dark:text-primary-400"></i>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Results</h3>
                <span class="px-2 py-1 bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 text-xs font-medium rounded-full">
                  {{ result_count }} found
                </span>
              </div>
              {% if deep_link %}
              <button onclick="navigator.clipboard.writeText(window.location.origin + '{{ deep_link }}')" title="Copy deep link"
                class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-400 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
                <i data-lucide="link" class="w-3.5 h-3.5"></i>
                Copy link
              </button>
              {% endif %}
            </div>
          </div>

          <div class="divide-y divide-slate-200 dark:divide-slate-700">
            {% for r in results %}
              <a href="/mail/{{ project.slug }}/message/{{ r.id }}"
                 class="block p-6 hover:bg-slate-50 dark:hover:bg-slate-900 transition-all duration-200 group">
                <div class="flex items-start justify-between mb-2">
                  <h4 class="text-base font-semibold text-slate-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors flex-1 mr-3">
                    {{ r.subject }}
                  </h4>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    {% if r.ack_required %}
                      <span class="px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 text-xs font-medium rounded">ACK</span>
                    {% endif %}
                    {% if r.importance == "urgent" %}
                      <span class="px-1.5 py-0.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-xs font-medium rounded">Urgent</span>
                    {% elif r.importance == "high" %}
                      <span class="px-1.5 py-0.5 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 text-xs font-medium rounded">High</span>
                    {% endif %}
                    {% if r.score %}
                      <span class="px-1.5 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-xs font-mono rounded" title="Relevance score">{{ r.score }}</span>
                    {% endif %}
                  </div>
                </div>

                <div class="flex items-center gap-4 text-sm text-slate-600 dark:text-slate-400 mb-2">
                  <div class="flex items-center gap-1.5">
                    <i data-lucide="user" class="w-3.5 h-3.5"></i>
                    <span>{{ r.from }}</span>
                  </div>
                  <div class="flex items-center gap-1.5" title="{{ r.created }}">
                    <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                    <span>{{ r.created_relative }}</span>
                  </div>
                  {% if r.thread_id %}
                    <a href="/mail/{{ project.slug }}/thread/{{ r.thread_id }}" class="flex items-center gap-1.5 hover:text-primary-600 dark:hover:text-primary-400 transition-colors" onclick="event.stopPropagation()">
                      <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                      <span class="font-mono text-xs">{{ r.thread_id }}</span>
                    </a>
                  {% endif %}
                </div>

                {% if r.snippet %}
                  <div class="text-sm text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 line-clamp-3">
                    {{ r.snippet | safe }}
                  </div>
                {% endif %}

                <div class="flex items-center gap-2 mt-2 text-primary-600 dark:text-primary-400 opacity-0 group-hover:opacity-100 transition-opacity">
                  <span class="text-sm font-medium">View message</span>
                  <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                </div>
              </a>
            {% endfor %}
          </div>

          <!-- Pagination -->
          {% if next_cursor %}
          <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex items-center justify-between">
            <span class="text-sm text-slate-600 dark:text-slate-400">Showing {{ result_count }} results</span>
            <a href="/mail/{{ project.slug }}/search?q={{ q }}&order={{ order }}&scope={{ scope }}{% if boost %}&boost=1{% endif %}{% for imp in importance %}&imp={{ imp }}{% endfor %}{% if agent %}&agent={{ agent }}{% endif %}{% if thread %}&thread={{ thread }}{% endif %}{% if ack != 'any' %}&ack={{ ack }}{% endif %}{% if direction %}&direction={{ direction }}{% endif %}{% if from_date %}&from_date={{ from_date }}{% endif %}{% if to_date %}&to_date={{ to_date }}{% endif %}&cursor={{ next_cursor }}"
               class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
              Next page
              <i data-lucide="chevron-right" class="w-4 h-4"></i>
            </a>
          </div>
          {% endif %}
        </div>

      {% elif q %}
        <!-- No Results -->
        <div class="bg-white dark:bg-slate-800 rounded-xl p-16 shadow-soft border border-slate-200 dark:border-slate-700 text-center">
          <div class="w-24 h-24 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="search-x" class="w-12 h-12 text-slate-400 dark:text-slate-500"></i>
          </div>
          <h3 class="text-2xl font-semibold text-slate-900 dark:text-white mb-3">No results found</h3>
          <p class="text-slate-600 dark:text-slate-400 mb-6 max-w-md mx-auto">
            No messages match your search query. Try different keywords, adjust filters, or check the query help.
          </p>
          <a href="/mail/{{ project.slug }}/search"
             class="inline-flex px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-medium hover:shadow-large transition-all duration-300 items-center gap-2 btn-ripple">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Clear Search
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Saved Recipes Sidebar -->
    {% if recipes %}
    <div class="w-72 flex-shrink-0 hidden lg:block">
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-soft border border-slate-200 dark:border-slate-700 sticky top-6">
        <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700">
          <h3 class="text-sm font-semibold text-slate-900 dark:text-white flex items-center gap-2">
            <i data-lucide="bookmark" class="w-4 h-4 text-primary-600 dark:text-primary-400"></i>
            Saved Searches
          </h3>
        </div>
        <div class="divide-y divide-slate-100 dark:divide-slate-700 max-h-96 overflow-y-auto">
          {% for recipe in recipes %}
          <a href="/mail/{{ project.slug }}{{ recipe.route }}"
             class="block px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-900 transition-colors group">
            <div class="flex items-center gap-2 mb-1">
              {% if recipe.pinned %}
                <i data-lucide="pin" class="w-3 h-3 text-primary-500 flex-shrink-0"></i>
              {% endif %}
              <span class="text-sm font-medium text-slate-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400 truncate">{{ recipe.name }}</span>
            </div>
            {% if recipe.description %}
              <p class="text-xs text-slate-500 dark:text-slate-400 truncate">{{ recipe.description }}</p>
            {% endif %}
            <span class="text-xs text-slate-400 dark:text-slate-500">{{ recipe.use_count }} uses</span>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('searchForm');
    const input = document.getElementById('q');
    let timeout;

    // Debounced search on text input
    input?.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        if (input.value.length >= 2 || input.value.length === 0) {
          form.submit();
        }
      }, 600);
    });

    // Auto-submit on filter changes
    document.querySelectorAll('select[name="agent"], input[name="direction"], input[name="ack"]').forEach(el => {
      el.addEventListener('change', () => form.submit());
    });
  });
</script>
{% endblock %}
