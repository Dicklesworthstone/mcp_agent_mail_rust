#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "${script_dir}/.." && pwd)"

usage() {
  cat <<'EOF'
Usage: am [serve] [options] [-- <extra args for `mcp-agent-mail serve`>]

Convenience runner for local MCP Agent Mail development.
Defaults:
- MCP transport path (`/mcp/`)
- LOG_RICH_ENABLED=true
- host=127.0.0.1, port=8765

Note: The Rust binary auto-discovers HTTP_BEARER_TOKEN from
~/.mcp_agent_mail/.env (fallback: ~/mcp_agent_mail/.env). This wrapper
is optional; `mcp-agent-mail serve` works without it.

Options:
  --host <host>          Server host (default: 127.0.0.1)
  --port <port>          Server port (default: 8765)
  --path <mcp|api|/x/>   Base path (default: mcp)
  --mcp                  Shortcut for --path mcp
  --api                  Shortcut for --path api
  --env-file <path>      Env file for HTTP_BEARER_TOKEN (default: ~/.mcp_agent_mail/.env, fallback: ~/mcp_agent_mail/.env)
  --no-auth              Unset HTTP_BEARER_TOKEN for this run
  --no-tui               Disable interactive TUI (headless mode)
  -h, --help             Show help

Examples:
  scripts/am
  scripts/am serve
  scripts/am --path api
  scripts/am --api
  scripts/am --host 0.0.0.0 --port 9000
EOF
}

normalize_http_path() {
  local value="$1"
  case "$value" in
    mcp|/mcp|/mcp/) echo "/mcp/" ;;
    api|/api|/api/) echo "/api/" ;;
    *)
      if [[ "$value" != /* ]]; then
        value="/$value"
      fi
      if [[ "$value" != */ ]]; then
        value="$value/"
      fi
      echo "$value"
      ;;
  esac
}

read_env_value() {
  local file="$1"
  local key="$2"
  if [[ ! -f "$file" ]]; then
    return 1
  fi
  command grep -E "^[[:space:]]*${key}=" "$file" | tail -n1 | cut -d= -f2-
}

default_env_file() {
  local preferred="${HOME}/.mcp_agent_mail/.env"
  local legacy="${HOME}/mcp_agent_mail/.env"
  if [[ -f "$preferred" ]]; then
    echo "$preferred"
  elif [[ -f "$legacy" ]]; then
    echo "$legacy"
  else
    echo "$preferred"
  fi
}

if [[ $# -gt 0 ]]; then
  case "$1" in
    serve) shift ;;
    help|-h|--help)
      usage
      exit 0
      ;;
  esac
fi

host="127.0.0.1"
port="8765"
path_mode="mcp"
env_file="$(default_env_file)"
no_auth=0
no_tui=0
extra_args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --host)
      host="${2:-}"
      shift 2
      ;;
    --port)
      port="${2:-}"
      shift 2
      ;;
    --path)
      path_mode="${2:-}"
      shift 2
      ;;
    --mcp)
      path_mode="mcp"
      shift
      ;;
    --api)
      path_mode="api"
      shift
      ;;
    --env-file)
      env_file="${2:-}"
      shift 2
      ;;
    --no-auth)
      no_auth=1
      shift
      ;;
    --no-tui)
      no_tui=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      extra_args=("$@")
      break
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

resolved_path="$(normalize_http_path "$path_mode")"
export LOG_RICH_ENABLED="${LOG_RICH_ENABLED:-true}"

# Reuse an already-running Agent Mail server on the same host/port to avoid
# clobbering a healthy instance started by another tool/agent.
if [[ "${AM_REUSE_RUNNING:-1}" == "1" ]]; then
  listener_pid=""
  listener_cmd=""
  if command -v lsof >/dev/null 2>&1; then
    listener_pid="$(lsof -tiTCP:"${port}" -sTCP:LISTEN 2>/dev/null | head -n1 || true)"
  fi
  if [[ -n "$listener_pid" ]]; then
    listener_cmd="$(ps -p "$listener_pid" -o args= 2>/dev/null || true)"
    if [[ "$listener_cmd" == *"mcp_agent_mail"* ]] || [[ "$listener_cmd" == *"mcp-agent-mail"* ]]; then
      echo "am: reusing existing Agent Mail server on ${host}:${port} (pid ${listener_pid})." >&2
      exit 0
    fi
    echo "am: port ${port} is in use by a non-Agent-Mail process (pid ${listener_pid})." >&2
    echo "am: free the port or choose a different one with --port." >&2
    exit 2
  fi
fi

if [[ "$no_auth" -eq 1 ]]; then
  unset HTTP_BEARER_TOKEN
else
  if [[ -z "${HTTP_BEARER_TOKEN:-}" ]]; then
    if token="$(read_env_value "$env_file" "HTTP_BEARER_TOKEN" 2>/dev/null)"; then
      token="$(printf '%s' "$token" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
      token="$(printf '%s' "$token" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")"
      if [[ -n "$token" ]]; then
        export HTTP_BEARER_TOKEN="$token"
      fi
    fi
  fi
fi

tui_flag=()
if [[ "$no_tui" -eq 1 ]]; then
  tui_flag=(--no-tui)
fi

cd "$repo_root"
echo "am: host=${host} port=${port} path=${resolved_path} tui=$([[ "$no_tui" -eq 0 ]] && echo on || echo off) rich=${LOG_RICH_ENABLED}" >&2

# Use release binary if available, fall back to cargo run
binary="${CARGO_TARGET_DIR:-${repo_root}/target}/release/mcp-agent-mail"
if [[ -x "$binary" ]]; then
  exec "$binary" serve --host "$host" --port "$port" --path "$resolved_path" "${tui_flag[@]}" "${extra_args[@]}"
else
  exec cargo run --release -p mcp-agent-mail -- serve --host "$host" --port "$port" --path "$resolved_path" "${tui_flag[@]}" "${extra_args[@]}"
fi
